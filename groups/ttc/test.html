<!DOCTYPE html>
<html>
  	<head>
    		<meta charset="UTF-8">
    		<meta name="viewport" content="width=device-width, initial-scale=1.0">
    		<title>DIYexhibition</title>
    		<link href="./style.css" rel="stylesheet" type="text/css" media="all">
    		<style>
			body { margin: 0; }
			canvas { display: block; }
		</style>
	</head>
	<body>
		
		<script type="module">
			import * as THREE from "./build/three.module.js";
			import {PointerLockControls} from "./js/PointerLockControls.js";
			import {GLTFLoader} from "./js/GLTFLoader.js";
			import {EffectComposer} from './js/EffectComposer.js';
			import {RenderPass} from './js/RenderPass.js';
			import {HalftonePass} from './js/HalftonePass.js';
			
			
			var scene = new THREE.Scene();
			scene.background = new THREE.Color(0x495261);
			var camera = new THREE.PerspectiveCamera( 75,window.innerWidth/window.innerHeight,0.1,1000);
			camera.position.y=1.2;

			var renderer = new THREE.WebGLRenderer();
			renderer.setSize( window.innerWidth, window.innerHeight );
			document.body.appendChild( renderer.domElement );
			var clock=new THREE.Clock();

			var controls=new PointerLockControls(camera,document.body);

			var forward=0;
			var sideways=0;
			var speed=0.02;
			
			//initialise audio context
			var context=false;
			document.addEventListener("click",audio);
			
			//movement
			function keyPress(event){
				switch(event.keyCode){
				  case 87:
					forward=1;
					break;
				case 83:
					forward=-1;
					break;
				case 65:
					sideways=-1;
					break;
				case 68:
					sideways=1;
					break;
				}
			}
			
			function keyRelease(event){
				switch(event.keyCode){
					case 87:
						forward=0;
						break;
					case 83:
						forward=0;
						break;
					case 65:
						sideways=0;
						break;
					case 68:
						sideways=0;
						break;
				}
			}
			
			//collision
			var raycaster=new THREE.Raycaster();
			var intersects;
			var mouse= new THREE.Vector2();
			var load=true;
			function onMouseMove(event){
				mouse.x=(event.clientX/window.innerWidth)*2-1;
				mouse.y=-(event.clientY/window.innerHeight)*2+1;
			}
			
			
			document.addEventListener("mousemove",onMouseMove);
			document.addEventListener("keydown",keyPress);
			document.addEventListener("keyup",keyRelease);
			document.addEventListener("click",function(){controls.lock();});
			
			
			//geometery
			var floorGeo=new THREE.PlaneGeometry(5,5);
			var rugGeo=new THREE.PlaneGeometry(3,1.5);
			var loader=new THREE.TextureLoader();

			//floor texture
			loader.load("./textures/woodfloorlores.jpg",(texture)=>{
				texture.wrapS = THREE.RepeatWrapping;
				texture.wrapT = THREE.RepeatWrapping;
				texture.repeat.set( 4, 4 );
				var floorTexture=new THREE.MeshPhongMaterial({
					map: texture,
				});
				var floor=new THREE.Mesh(floorGeo,floorTexture);
				floor.rotation.x=-Math.PI/2;
				floor.name="floor";
				scene.add(floor);
			});

			//rug texture
			loader.load("./textures/ruglores.png",(texture)=>{
				var rugTexture=new THREE.MeshPhongMaterial({
					map: texture,
					transparent: true,
				});
				var rug=new THREE.Mesh(rugGeo,rugTexture);
				rug.rotation.set(-Math.PI/2,0,Math.PI/2);
				rug.position.y+=0.05;
				scene.add(rug);
			});
			
			var wallTexture=new THREE.MeshPhongMaterial({color:0xb9dbb2});
			var ceilingTexture=new THREE.MeshPhongMaterial({color:0xf2e3c4});
			var wallGeo=new THREE.PlaneGeometry(5,2);
			var walls=[];
			for(var i=0;i<4;i++){
				walls[i]=new THREE.Mesh(wallGeo,wallTexture);
				walls[i].name="Wall";
				scene.add(walls[i]);
			}
			var ceiling=new THREE.Mesh(floorGeo,ceilingTexture);
			ceiling.name="ceiling";
			
			var light=new THREE.PointLight(0xFFFFFF,1.9,7,3);

			scene.add(ceiling);
			scene.add(light);
			scene.add(controls.getObject());
			
			walls[0].position.set(0,1,-2.5);
			
			walls[1].rotation.y=Math.PI/2;
			walls[1].position.set(-2.5,1,0);

			walls[2].rotation.y=-Math.PI/2;
			walls[2].position.set(2.5,1,0);

			walls[3].rotation.y=Math.PI;
			walls[3].position.set(0,1,2.5);

			ceiling.rotation.x=Math.PI/2;
			ceiling.position.y=2;
			
			//model loading
			var boxes=[];
			var boundingBox=[];
			var models=["lamp","wardrobe","bed","chair","desk","table","shelf"]
			var coords=[[2,-2],[-1.9,-2.1],[1.8,1.7],[-2,2], [-2.1, 0],[0.7,2],[0.2,-2.4]];
			var dist=1.75;
			var loader=new GLTFLoader();
			for(let i=0;i<models.length;i++){
				loader.load("models/"+models[i]+".glb",function(gltf){
					boundingBox[i]=new THREE.Box3();
					gltf.scene.position.set(coords[i][0],0,coords[i][1]);
					boxes[i]=gltf.scene;
					scene.add(boxes[i]);
					boundingBox[i].setFromObject(boxes[i]);
				},undefined,function(error){
					console.error(error);
				});
			}
			
			//audio
			var sounds=[];
			var soundFiles=["fifths","wind","voice","tape"];
			function audio(){
				if(!context){
					var listener=new THREE.AudioListener();
					camera.add(listener);
					var audioLoader=new THREE.AudioLoader();
					
					for(let i=0;i<4;i++){
						sounds[i]=new THREE.PositionalAudio(listener);
						sounds[i].setRolloffFactor(5)
						audioLoader.load("sounds/"+soundFiles[i]+".wav",
						function(buffer){
							sounds[i].setBuffer(buffer);
							sounds[i].setLoop(true);
							sounds[i].setVolume(0.4);
							sounds[i].play();
						});
						boxes[i].add(sounds[i]);
					}
					context=true;
				}
			}
			
			var playerGeo=new THREE.BoxGeometry(0.25,1,0.25);
			var player=new THREE.Mesh(playerGeo,wallTexture);
			var playerCollider=new THREE.Box3();
			scene.add(player);

			//post processing
			var composer, renderPass, halftonePass,params;
			
			composer=new EffectComposer(renderer);
			renderPass=new RenderPass(scene,camera);
			params={
				shape: 1,
				radius: 1,
				rotateR: Math.PI/12,
				rotateB: Math.PI/12*2,
				rotateG: Math.PI/12*3,
				scatter: 0.2,
				blending: 0.8,
				blendingMode: 1,
				greyscale: false,
				disable: false
			};
			halftonePass=new HalftonePass(window.innerWidth,window.innerHeight,params);
			composer.addPass(renderPass);
			composer.addPass(halftonePass);
			
			function animate(){
				requestAnimationFrame(animate);
				var delta=clock.getDelta();
				
				var prev=new THREE.Vector2(camera.position.x,camera.position.z);
				
				raycaster.setFromCamera(mouse,camera);
				intersects=raycaster.intersectObjects(scene.children,true);
				controls.moveForward(forward*speed);
				controls.moveRight(sideways*speed);
				
				player.position.set(camera.position.x,0.7,camera.position.z);
				playerCollider.setFromObject(player);
				
				for(var i=0;i<boundingBox.length;i++){
					if(playerCollider.intersectsBox(boundingBox[i])){
						var inter=playerCollider.intersect(boundingBox[i]);
						if(inter.max.z-inter.min.z>=inter.max.x-inter.min.x){
							camera.position.x=prev.x;
						}
						if(inter.max.x-inter.min.x>=inter.max.z-inter.min.z){
							camera.position.z=prev.y;
						}
					}
				}
				
				camera.position.x=Math.min(Math.max(camera.position.x,-2.3,),2.3);
				camera.position.z=Math.min(Math.max(camera.position.z,-2.3,),2.3);
				light.position.set(camera.position.x,camera.position.y,camera.position.z);

				composer.render(delta);
			}

			animate();
		</script>

	<div class="back"><a href="../../homepage.html"> return to homepage </a></div>


	</body>
</html>
